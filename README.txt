===============================================
     CFRD SUPPORT BOT v2 - РУКОВОДСТВО
===============================================

Телеграм-бот для поддержки клиентов CFRD.
Работает через Telegram Business Account с форум-топиками.

===============================================
              ПРИНЦИП РАБОТЫ
===============================================

Бот использует Telegram Business Account для обработки
сообщений от клиентов. Когда клиент пишет в личные
сообщения бизнес-аккаунту, бот:

1. Создаёт топик (тред) в группе поддержки
2. Пересылает сообщение клиента в этот топик
3. Менеджеры отвечают командами в топике
4. Бот отправляет ответ клиенту от имени бизнес-аккаунта

СХЕМА РАБОТЫ:
  Клиент -> Бизнес-аккаунт -> Бот -> Группа (топик)
  Группа (топик) -> Бот -> Бизнес-аккаунт -> Клиент

ОТСЛЕЖИВАНИЕ:
- Неотвеченные сообщения (уведомления менеджерам)
- Редактирование/удаление сообщений клиентом
- Реакции клиента на сообщения
- Цитаты и ответы (reply)

===============================================
               УСТАНОВКА
===============================================

ТРЕБОВАНИЯ:
- Python 3.10+
- Telegram Business Account
- Группа с включенными топиками (форум)

ШАГИ УСТАНОВКИ:

1. Клонировать репозиторий:
   git clone https://github.com/dscfrd/cfrd-support-bot-v2
   cd cfrd-support-bot-v2

2. Создать виртуальное окружение:
   python3 -m venv venv
   source venv/bin/activate

3. Установить зависимости:
   pip install pyrofork tgcrypto

4. Настроить config.py:
   - API_ID и API_HASH (получить на my.telegram.org)
   - PHONE_NUMBER (номер бизнес-аккаунта)
   - SUPPORT_GROUP_ID (ID группы поддержки)
   - SESSION_NAME (имя файла сессии)

5. Первый запуск (авторизация):
   ./venv/bin/python bot.py
   (ввести код из Telegram)

6. Запуск в фоне:
   nohup ./venv/bin/python bot.py >> bot.log 2>&1 &

ПРОВЕРКА РАБОТЫ:
   tail -f bot.log
   ps aux | grep python

ОСТАНОВКА:
   pkill -f "venv/bin/python bot.py"

===============================================
               ОСНОВНЫЕ КОМАНДЫ
===============================================

ОТВЕТЫ КЛИЕНТАМ:
  /[номер_треда] [текст]     - Ответить по номеру треда
                               Пример: /123 Добрый день!

  /[ИмяКлиента] [текст]      - Ответить по ID клиента
                               Пример: /Иванов Ваш заказ готов

  /del                        - Удалить сообщение у клиента
                               (reply на своё сообщение в треде)

  /card [номер_треда]         - Отправить визитку клиенту

===============================================
              УПРАВЛЕНИЕ КЛИЕНТАМИ
===============================================

  /id [треда] [ИмяКлиента]    - Задать ID клиенту
                               Пример: /id 123 Иванов
                               (только русские буквы и цифры)

  /company [треда] [Название] - Задать компанию клиенту
                               Пример: /company 123 ООО Ромашка

  /tier [треда] [1|2|3]       - Установить тир клиента
                               1 = VIP, 2 = стандарт, 3 = базовый

===============================================
               ФОРМАТ ЗАГОЛОВКОВ
===============================================

Если ID задан:    "Иванов: Иван Петров | ООО Ромашка (123)"
Если ID не задан: "123: Иван Петров | ООО Ромашка"

===============================================
             ОТВЕТСТВЕННЫЕ МЕНЕДЖЕРЫ
===============================================

  /onduty @username [треда]   - Назначить ответственного
                               Пример: /onduty @ivan 123

  /ok [треда]                 - Сбросить уведомления треда

  /duties                     - Список всех ответственных

  /threads                    - Список активных тредов

===============================================
           УПРАВЛЕНИЕ МЕНЕДЖЕРАМИ
===============================================

  /auth [эмодзи], [Имя], [Должность]
                              - Авторизоваться в системе
                              Пример: /auth 🔧, Иван Петров, менеджер

  /vacation @менеджер @заместитель [tier-1 tier-2 tier-3]
                              - Передать клиентов на время отпуска
                              Пример: /vacation @ivan @petr tier-1 tier-2

  /return @менеджер           - Вернуть клиентов из отпуска

  /team                       - Показать карточки всех менеджеров

  /fire @новый_менеджер       - Уволить менеджера (reply на карточку)
                              Передаёт все треды новому менеджеру

===============================================
                  ИНФОРМАЦИЯ
===============================================

  /myinfo                     - Ваша информация в системе
  /group_info [треда]         - Информация о группе
  /help                       - Краткая справка по командам
  /readme                     - Скачать это руководство

===============================================
               УВЕДОМЛЕНИЯ
===============================================

Бот автоматически отслеживает неотвеченные сообщения:
- Через 10 минут: сообщение становится срочным (огонёк в заголовке)
- Уведомления отправляются ответственному менеджеру
- Интервал повторных уведомлений: 20 минут

Настройки в config.py:
- URGENT_WAIT_TIME = 10      (минут до срочности)
- NOTIFICATION_INTERVAL = 20 (минут между уведомлениями)

===============================================
                 РЕАКЦИИ
===============================================

Бот отслеживает реакции клиентов на сообщения:
- Уведомление приходит в тред как reply
- Показывает какие эмодзи поставил/убрал клиент

===============================================
           РЕДАКТИРОВАНИЕ/УДАЛЕНИЕ
===============================================

Бот отслеживает когда клиент:
- Редактирует сообщение: показывает новый текст (reply)
- Удаляет сообщение: уведомляет в тред (reply)

===============================================
              СТРУКТУРА ПРОЕКТА
===============================================

cfrd-support-bot-v2/
├── bot.py           # Основной бот
├── config.py        # Конфигурация
├── database.py      # Работа с SQLite
├── venv/            # Виртуальное окружение
├── bot.log          # Логи
├── *.session        # Файл сессии Telegram
└── *.db             # База данных клиентов

===============================================
                  БАЗА ДАННЫХ
===============================================

SQLite база содержит таблицы:
- clients         - клиенты и их данные
- managers        - авторизованные менеджеры
- messages        - история сообщений
- duty_managers   - ответственные за треды
- thread_status   - статусы уведомлений
- message_mapping - связь сообщений клиент<->группа
- first_replies   - первые ответы менеджеров
- manager_substitutions - замещения на время отпуска

===============================================
           (c) CFRD Support Bot v2
       https://github.com/dscfrd/cfrd-support-bot-v2
===============================================
